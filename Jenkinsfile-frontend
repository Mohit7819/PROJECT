pipeline {
  agent any
  environment {
    APP_DIR = '/home/deployer/project/frontend'
    PM2_NAME = 'express-app'
  }
  stages {
    stage('Checkout') {
      steps {
        echo "Source code checked out"
      }
    }
    stage('Install dependencies') {
      steps {
        sh '''
          cd frontend
          npm ci
        '''
      }
    }
    stage('Deploy') {
      steps {
        sh '''
          sudo -u deployer rsync -av --delete frontend/ ${APP_DIR}/
          sudo -u deployer bash -lc "cd ${APP_DIR} && npm ci && pm2 restart ${PM2_NAME} || pm2 start npm --name ${PM2_NAME} -- start"
        '''
      }
    }
  }
}

