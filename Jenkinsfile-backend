pipeline {
    agent any

    environment {
        APP_DIR = "/home/deployer/project/backend"
        PM2_NAME = "flask-app"
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Source code checked out"
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                    # Copy project to deployer
                    sudo -u deployer rsync -av --delete backend/ ${APP_DIR}/

                    # Install & restart app as deployer
                    sudo -u deployer bash -lc "
                        cd ${APP_DIR} &&
                        python3 -m venv venv &&
                        source venv/bin/activate &&
                        pip install --upgrade pip &&
                        pip install -r requirements.txt &&
                        pip install gunicorn &&
                        pm2 restart ${PM2_NAME} || pm2 start ${APP_DIR}/venv/bin/gunicorn --name ${PM2_NAME} -- --bind 0.0.0.0:5000 app:app
                    "
                '''
            }
        }
    }
}

