pipeline {
  agent any
  environment {
    APP_DIR = '/home/deployer/flask-app'
    PM2_NAME = 'flask-app'
    GIT_BRANCH = 'main'
  }
  stages {
    stage('Checkout') {
      steps {
        echo "Flask source code checked out"
      }
    }

    stage('Install deps & Test') {
      steps {
        sh '''
          set -e
          python3 -m venv venv
          . venv/bin/activate
          pip install -r requirements.txt
          pytest || true
        '''
      }
    }

    stage('Deploy to server') {
      steps {
        sh '''
          set -e
          sudo -u deployer rsync -av --delete ${WORKSPACE}/ ${APP_DIR}/
          sudo -u deployer bash -lc "cd ${APP_DIR} && . venv/bin/activate && pip install -r requirements.txt && pm2 restart ${PM2_NAME} || pm2 start gunicorn --name ${PM2_NAME} --bind 0.0.0.0:5000 'wsgi:app'"
        '''
      }
    }
  }

  post {
    success { echo "Flask deploy succeeded" }
    failure { echo "Flask deploy failed" }
  }
}

